{% extends 'reporting/layout.html.twig' %}
{% import "macros/datatables.html.twig" as tables %}

{% set columns = {
    'date':          {'class': 'alwaysVisible', 'title': 'date'},
} %}
{% set columns = columns|merge({
    'client':    {'class': 'd-md-table-cell', 'title': 'client'},
}) %}
{% set columns = columns|merge({
    'number':    {'class': 'd-md-table-cell', 'title': 'number'},
}) %}
{% set columns = columns|merge({
    'project':    {'class': 'd-md-table-cell', 'title': 'project'},
}) %}
{% set columns = columns|merge({
    'contributor':    {'class': 'd-md-table-cell', 'title': 'contributor'},
}) %}
{% set columns = columns|merge({
    'prohibited':    {'class': 'd-md-table-cell', 'title': 'prohibited'},
}) %}
{% set columns = columns|merge({
    'leaving':    {'class': 'd-md-table-cell', 'title': 'leaving'},
}) %}
{% set columns = columns|merge({
    'activity':    {'class': 'd-md-table-cell', 'title': 'activity'},
}) %}
{% set columns = columns|merge({
    'description':    {'class': 'd-md-table-cell  w-25', 'title': 'description'},
}) %}
{% set columns = columns|merge({
    'hours':    {'class': 'd-md-table-cell', 'title': 'hours'},
}) %}
{% set columns = columns|merge({
    'hours-minutes':    {'class': 'd-md-table-cell', 'title': 'hours minutes'},
}) %}

{% set tableName = 'custom_report' %}

{% block main_before %}
    {{ tables.data_table_column_modal(tableName, columns) }}
{% endblock %}

{% block report_form_layout %}
    {{ form_start(form, {'attr': {'class': 'form-reporting', 'id': 'report-form'}}) }}
    <div class="btn-list w-100">
        {{ form_widget(form.month, {'label': false}) }}
        {{ form_widget(form.customer, {'label': false, 'placeholder': 'Client'}) }}
        {{ form_widget(form.user, {'label': false, 'placeholder': 'User'}) }}
        {% from '@theme/components/buttons.html.twig' import submit_button %}
        {{ submit_button('download', {'attr': {'formaction': path(export_route)}, 'icon': 'download', 'combined': false}, 'primary') }}
    </div>
    {{ form_end(form) }}
{% endblock %}

{% block report %}

    {% set hasData = timesheets|length > 0 %}

    {% embed '@theme/embeds/card.html.twig' %}
        {% import "macros/progressbar.html.twig" as progress %}
        {% import "macros/widgets.html.twig" as widgets %}
        {% import "macros/datatables.html.twig" as tables %}
        {% import "project/actions.html.twig" as projectActions %}
        {% block box_body_class %}{{ tableName }}-box {% if hasData %}p-0{% endif %}{% endblock %}
        {% block box_body %}
            {% if not hasData %}
                {{ widgets.nothing_found() }}
            {% else %}
                {{ tables.datatable_header(tableName, columns, null, {'boxClass': ''}) }}
                {% for timesheet in timesheets %}
                    {% set weekend = timesheet.begin|date("N") %}
                    <tr {{ weekend >= 6 ? 'class="bgWeek"' : '' }}>
                        <td>
                            {{ timesheet.begin|date('d/m/Y', timesheet.timezone) }}
                        </td>
                        <td>{{ timesheet.project.customer.name }}</td>
                        <td>{{ timesheet.project.number }}</td>
                        <td>{{ timesheet.project.name }}</td>
                        <td>{{ timesheet.user.username }}</td>
                        <td>{{ timesheet.begin|date('H:i', timesheet.timezone) }}</td>
                        <td>{{ timesheet.end|date('H:i', timesheet.timezone) }}</td>
                        <td>{{ timesheet.activity.name }}</td>
                        <td><div style="overflow: hidden;display: -webkit-box;-webkit-line-clamp: 2;line-clamp: 2; -webkit-box-orient: vertical;" title="{{ timesheet.description }}">{{ timesheet.description }} </div></td>
                        <td>{{ timesheet.duration|date('H:i', false) }}</td>
                        <td>{{ (timesheet.duration|date('i', false)/60+timesheet.duration|date('H', false))|number_format(2, ',', '.')  }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="4"></td>
                    <td colspan="6" style="text-align: right;">
                        <strong>Total de horas:</strong>
                    </td>
                    <td>{{ totalHours|number_format(2, ':', '.') }}</td>
                </tr>
                {{ tables.data_table_footer() }}
            {% endif %}
        {% endblock %}
    {% endembed %}
    <style>
        .bgWeek{
            background-color:rgb(239,239,0,0.18);
        }
    </style>
{% endblock %}
